{% extends 'core/base_admin.html' %}
{% load static %}

{% block title %}Listado de Compras Pendientes{% endblock %}
<head>
{% block extra_head%}
    <link rel="stylesheet" href="{% static 'administrador/css/lista_usuarios.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
{% endblock %}
</head>

{% block content %}

<div class="acciones-derecha ancho-contenido">
    <a href="#" class="boton-header">
        Dashboard
        <img src="{% static 'administrador/svg/reporteria.svg' %}">
    </a>

    <a href="{% url 'registrar_compra' %}" class="boton-header">
        Registrar Compra
        <img src="{% static 'administrador/svg/plus.svg' %}">
    </a>
</div>

{% if messages %}
    <ul class="messages">
        {% for message in messages %}
            <li class="{{ message.tags }}">{{ message }}</li>
        {% endfor %}
    </ul>
{% endif %}

<h2 class="titulo">Listado de Compras Pendientes</h2>

<div class="busqueda-agregar">
    <input type="text" placeholder="Buscar Compra .........." class="input-busqueda">


    <div class="dropdown">
        <a href="#" class="boton-header" id="dropdownMenuButton">
            Filtrar
            <img src="{% static 'administrador/svg/filter-solid.svg' %}">
        </a>
        <ul id="filterOptions" class="dropdown-content" style="display:none;">
            <li><a href="#" onclick="applyFilter('nombre')" data-filter="nombre" class="{% if order_by == 'nombre' %}filtro-activo{% endif %}">Nombre</a></li>
            <li><a href="#" onclick="applyFilter('rut')" data-filter="rut" class="{% if order_by == 'rut' %}filtro-activo{% endif %}">Rut</a></li>
            <li><a href="#" onclick="clearOrderFilter()">Limpiar filtro</a></li>
        </ul>
    </div>
</div>

<div class="barra-acciones-usuarios ancho-contenido">
    <div class="boton-bloquear-seleccionados">
        <button id="bloquearBtn" disabled>Bloquear</button>
    </div>

    <div class="toggle-estado-usuarios">
        <a href="{% url 'lista_compras_activas' %}" class="estado-btn activo">Pendientes</a>
        <a href="{% url 'lista_compras_bloqueadas' %}" class="estado-btn">Listas</a>
    </div>
</div>

<div id="confirmModal" class="modal hidden">
  <div class="modal-content">
    <h3>¿Bloquear Compra?</h3>
    <p>Las compras bloqueadas pasarán al listado de bloqueados y su estado pasará a "cancelado".</p>
    <div class="modal-actions">
      <button type="button" id="confirmNo">Cancelar</button>
      <button type="button" id="confirmYes">Confirmar</button>
    </div>
  </div>
</div>

<div id="confirmAprobarModal" class="modal" style="display: none;">
  <div class="modal-content">
    <p>¿Estás seguro de que deseas aprobar esta compra?</p>
    <div class="modal-buttons">
      <button id="confirmAprobarBtn" class="btn-confirm">Sí, aprobar</button>
      <button id="cancelAprobarBtn" class="btn-cancel">Cancelar</button>
    </div>
  </div>
</div>

<div id="detalleCompraModal" class="modal hidden">
  <div class="modal-content">
    <span class="close-modal" id="cerrarDetalleCompra">&times;</span>
    <div id="contenidoDetalleCompra">
    </div>
  </div>
</div>

{% if compras %}
    <table class="tabla-usuarios">
        <thead>
            <tr>
                <th><input type="checkbox" id="select-all"></th>
                <th>ID Compra</th>
                <th>Proveedor</th>
                <th>Encargado</th>
                <th>Fecha Compra</th>
                <th>Estado</th>            
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for compra in compras %}
            <tr>
                <td data-label="Seleccionar"><input type="checkbox" class="select-user" data-compra-id="{{ compra.id }}"></td>
                <td data-label="ID Compra">{{ compra.id }}</td>
                <td data-label="Proveedor">{{ compra.proveedor.nombre }}</td>
                <td data-label="Encargado">{{ compra.usuario }}</td>
                <td data-label="Fecha Compra">{{ compra.fecha }}</td>
                <td data-label="Estado">{{ compra.estado}}</td>
                <td data-label="Acciones">
                    <button title="Bloquear" class="btn-bloquear" data-compra-id="{{ compra.id }}">
                        <img src="{% static 'core/svg/lock-open-solid.svg' %}" alt="Bloquear">
                    </button>
                    <a href="{% url 'detalle_compra' compra.id %}" title="Mostrar">
                        <img src="{% static 'core/svg/user-regular.svg' %}" alt="Mostrar">
                    </a>
                    <button class="btn-aprobar" data-id="{{ compra.id }}">
                        ✅
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="custom-pagination">
        {% if compras.has_previous %}
        <a href="?page=1{% if order_by %}&order_by={{ order_by }}{% endif %}" class="page-btn">&laquo;</a>
        <a href="?page={{ compras.previous_page_number }}{% if order_by %}&order_by={{ order_by }}{% endif %}" class="page-btn">&lsaquo;</a>
        {% else %}
        <span class="page-btn disabled">&laquo;</span>
        <span class="page-btn disabled">&lsaquo;</span>
        {% endif %}

        <span class="page-btn current">{{ compras.number }}</span>

        {% if compras.has_next %}
        <a href="?page={{ compras.next_page_number }}{% if order_by %}&order_by={{ order_by }}{% endif %}" class="page-btn">&rsaquo;</a>
        <a href="?page={{ compras.paginator.num_pages }}{% if order_by %}&order_by={{ order_by }}{% endif %}" class="page-btn">&raquo;</a>
        {% else %}
        <span class="page-btn disabled">&rsaquo;</span>
        <span class="page-btn disabled">&raquo;</span>
        {% endif %}
    </div>
{% else %}
    <p style="text-align: center; font-size: 24px; margin-top: 40px;">No hay compras registradas.</p>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const aprobarButtons = document.querySelectorAll('.btn-aprobar');

    aprobarButtons.forEach(function (button) {
        button.addEventListener('click', function () {
            const compraId = this.getAttribute('data-id');
            showConfirmAprobarModal(() => {
                fetch("{% url 'aprobar_compra' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: new URLSearchParams({ 'compra_id': compraId })
                })

                .then(res => res.json())
                .then(data => {
                    console.log(data); // Útil para depurar
                    if (data.success) {
                        location.reload();
                    } else {
                        alert(data.message || 'Ocurrió un error al aprobar la compra.');
                    }
                })
                .catch(error => {
                    console.error('Error en fetch:', error);
                    alert('Error inesperado al aprobar la compra.');
                });
            });
        });
    });

    function showConfirmAprobarModal(callback) {
        const modal = document.getElementById('confirmAprobarModal');
        const confirmBtn = document.getElementById('confirmAprobarBtn');
        const cancelBtn = document.getElementById('cancelAprobarBtn');

        modal.style.display = 'block';

        const closeModal = () => {
            modal.style.display = 'none';
            confirmBtn.removeEventListener('click', onConfirm);
            cancelBtn.removeEventListener('click', closeModal);
        };

        const onConfirm = () => {
            callback();
            closeModal();
        };

        confirmBtn.addEventListener('click', onConfirm);
        cancelBtn.addEventListener('click', closeModal);
    }
});

document.addEventListener('DOMContentLoaded', function () {
    const bloquearButtons = document.querySelectorAll('.btn-bloquear');

    bloquearButtons.forEach(function (button) {
        button.addEventListener('click', function () {
            const compraId = this.getAttribute('data-compra-id');
            const modal = document.getElementById('confirmModal');

            modal.classList.remove('hidden');

            const confirmYes = document.getElementById('confirmYes');
            const confirmNo = document.getElementById('confirmNo');

            const closeModal = () => {
                modal.classList.add('hidden');
                confirmYes.removeEventListener('click', onConfirm);
                confirmNo.removeEventListener('click', closeModal);
            };

            const onConfirm = () => {
                fetch("{% url 'bloquear_compra' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: new URLSearchParams({ 'compra_id': compraId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert(data.message || 'Error al bloquear la compra.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Ocurrió un error inesperado.');
                })
                .finally(() => {
                    closeModal();
                });
            };

            confirmYes.addEventListener('click', onConfirm);
            confirmNo.addEventListener('click', closeModal);
        });
    });
});

</script>

<script src="{% static 'administrador/js/filtro_orden_usuario.js' %}"></script>
<script src="{% static 'administrador/js/busca_usuarios.js' %}"></script>


{% endblock %}
